require('dotenv').config();
process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';

const { GigaChat } = require('gigachat');

class AiService {
  constructor() {
    this.client = new GigaChat({
      model: "GigaChat-2",
      credentials: process.env.GIGACHAT_KEY
    });
  }

  async askLibrary(question, currentPage = '/', userBooks = [], userName = '–¥—Ä—É–≥') {
  const pageContext = this.getPageContext(currentPage);
  const booksContext = userBooks.length ? `–¢–≤–æ–∏ –ª—é–±–∏–º—ã–µ –∫–Ω–∏–≥–∏: ${userBooks.slice(0,3).join(', ')} üìö` : '';

  const response = await this.client.chat({
    messages: [{
      role: "system",
      content: `–¢—ã —Ç–µ–ø–ª—ã–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å –∫–Ω–∏–∂–Ω–æ–≥–æ –∫–ª—É–±–∞ "–ß–∏—Ç–∞–π–¥–æ–º" ‚Äî –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —É—é—Ç–Ω—ã–π –∫–∞–∫ –≤–µ—á–µ—Ä —Å –∫–Ω–∏–≥–æ–π —É –∫–∞–º–∏–Ω–∞ ‚ú®

–ì–û–í–û–†–ò –¢–ï–ü–õ–û, —Å —ç–º–æ–¥–∑–∏ üìñüí´üåü:
‚Ä¢ –û–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏: "${userName}, –ø—Ä–∏–≤–µ—Ç!" –∏–ª–∏ "${userName}, –¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º—Å—è"
‚Ä¢ –î–æ–±–∞–≤–ª—è–π üìö‚ú®üå∏ –≤ –æ—Ç–≤–µ—Ç—ã
‚Ä¢ –ë—É–¥—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º: "–†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å!", "–í—Å–µ –ø—Ä–æ—Å—Ç–æ!", "–î–∞–≤–∞–π –≤–º–µ—Å—Ç–µ!"

=== –ù–ê–í–ò–ì–ê–¶–ò–Ø (–¢–û–õ–¨–ö–û –¢–í–û–ò –ü–£–¢–ò): ===
üåü –ì–ª–∞–≤–Ω–∞—è / ‚Äî —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∫–Ω–∏–≥/–∞–≤—Ç–æ—Ä–æ–≤/–æ—Ü–µ–Ω–æ–∫)
üí´ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É ‚Äî –∫–Ω–æ–ø–∫–∞ "+–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É" –Ω–∞ –≥–ª–∞–≤–Ω–æ–π 
‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ /favorites ‚Äî –∫–Ω–æ–ø–∫–∞ "‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ /books/:id ‚Äî –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" –Ω–∞ –∫–Ω–∏–≥–µ
üîë –õ–æ–≥–∏–Ω /login | ‚ú® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è /registration

=== –¢–ï–ö–£–©–ê–Ø –°–¢–†–ê–ù–ò–¶–ê: ${pageContext} ===

${booksContext}

=== –¢–ï–ü–õ–´–ï –ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í ===
"–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É?" ‚Üí "${userName}, –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ '+–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É' üìñ –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏ '–°–æ–∑–¥–∞—Ç—å' ‚Äî –≥–æ—Ç–æ–≤–æ! ‚ú®"
"–ì–¥–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?" ‚Üí "${userName}, –∫–ª–∏–∫–Ω–∏ '‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' –Ω–∞ –ª—é–±–æ–π –∫–Ω–∏–≥–µ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–≤–æ—è –ø–æ–ª–æ—á–∫–∞ /favorites! üìö"
"–ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–Ω–∏–≥—É?" ‚Üí "${userName}, –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–Ω–∏–≥–∏ –∫–Ω–æ–ø–∫–∞ '–ü–æ–¥—Ä–æ–±–Ω–µ–µ' ‚Äî –∑–∞–≥–ª—è–Ω–∏ –≤–Ω—É—Ç—Ä—å! üåü"
"–ó–∞–±—ã–ª –ø–∞—Ä–æ–ª—å" ‚Üí "${userName}, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π! –ù–∞ /login –µ—Å—Ç—å '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å' ‚Äî –≤—Å–µ –Ω–∞–ª–∞–¥–∏–º üìñ"
"–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞" ‚Üí "${userName}, –¥–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º –∞–∫–∫–∞—É–Ω—Ç! /registration ‚Üí email + –ø–∞—Ä–æ–ª—å ‚Üí –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! ‚ú®"

–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –ò–ú–Ø, –≥–æ–≤–æ—Ä–∏ —Ç–µ–ø–ª–æ –∏ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏! üìöüí´`
    }, {
      role: "user",
      content: question
    }]
  });

  return response.choices[0].message.content;
}

  getPageContext(path) {
    switch(path) {
      case '/': return '–ì–ª–∞–≤–Ω–∞—è ‚Äî –≤–∏–¥–∏—à—å —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?';
      case '/favorites': return '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Ç–≤–æ–∏ –ª—é–±–∏–º—ã–µ –∫–Ω–∏–≥–∏';
      default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞';
    }
  }
}

module.exports = new AiService();
